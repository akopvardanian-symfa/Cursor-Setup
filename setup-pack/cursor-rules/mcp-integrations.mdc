---
description: MCP and integrations (Confluence, Jira) — general rules
alwaysApply: true
---

# MCP and integrations: Confluence, Jira

General rules for projects using MCP (mcp-atlassian), Confluence, and Jira. Not tied to specific projects or spaces.

## Main principles

- **Locally-first:** keep drafts and iterations in local files (Markdown, templates); update Confluence only when the user explicitly asks (“publish”, “sync”, “update in Confluence”).
- **Confluence is the source of truth** for published content: before writing to Confluence, consider the current state of the page (version, manual edits, comments).
- **Token economy:** prefer **scripts** from the `Technical/` folder (REST API) for heavy operations (attachments, bulk read/write); use MCP for search, one-off checks, and publishing content.

## When to use what

| Task | Prefer |
|------|--------|
| Edit documentation text | Local `.md` in the repo |
| Get current state of a Confluence page | MCP `confluence_get_page` (once) |
| Find a page / understand structure | MCP search (`confluence_search` / CQL) |
| Publish local edits to Confluence | MCP: `confluence_get_page` → `confluence_get_comments` → **if the doc has images** (`![](path)` or `![alt](path)`): run `Technical/upload_confluence_attachment.py <page_id> <path>` for each image first → then `confluence_update_page` |
| Attachments (upload, embed image, delete) | Scripts from `Technical/` (see below) |

## MCP (mcp-atlassian)

- Use **mcp-atlassian** by default for Confluence and Jira (search, pages, issues, comments, labels, boards, sprints, etc.).
- Write Confluence page content in **Markdown** (MCP supports markdown on write).

## Before updating a Confluence page

- Fetch current content once via MCP (`confluence_get_page` by `page_id`) so you don’t overwrite manual edits.
- If needed, fetch page comments (`confluence_get_comments`) and take discussions in comments into account.

## Conflicts: inform the user

- **Confluence:** before editing a page at the user’s request, check comments when possible. If comments contain alternative wording or disagreement with the current version — briefly inform the user.
- **Jira:** when changing issue fields at the user’s request — when possible check recent changes (changelog) or comments. If the same fields were recently changed or comments contradict — report a possible conflict.

Do not block the request, but clearly list any conflicts found.

## Confluence attachments

**Rule: when publishing a document that contains images — upload images first with the script.**  
If you are updating a Confluence page from a local file (.md, README, etc.) and that file contains image references like `![](path)` or `![alt](path)` with local paths — **before** calling `confluence_update_page`, run for each image:  
`Technical/upload_confluence_attachment.py <page_id> <path_to_image>`  
(Path is relative to repo root or to the folder containing the document.) Then update the page body. Otherwise only the text will appear in Confluence and image links will be broken.

**Use case: images when working with Confluence via MCP.**  
When reading or editing Confluence page content via MCP, **MCP cannot insert images or attachments onto a page**. Scripts in the `Technical/` folder are run by Cursor: when the user asks to insert an image on a Confluence page or says they can’t see an image on the page — run `Technical/confluence_upload_and_embed_image.py` (or `upload_confluence_attachment.py` if needed) with the appropriate `page_id` and file path.

Prefer managing attachments with **scripts** from the `Technical/` folder so large content doesn’t go through MCP.

- **List attachments:** MCP `confluence_get_page` (often returns a list in `metadata.attachments`) or page UI → Attachments.
- **Upload file as attachment:**  
  `Technical/upload_confluence_attachment.py <page_id> <path_to_file>`
- **Upload and embed image in page:**  
  `Technical/confluence_upload_and_embed_image.py <page_id> <path_to_image> [--anchor "..." --alt "..." --width N]`
- **Delete attachment** — only when the user explicitly asks:  
  `Technical/delete_confluence_attachment.py <page_id> <filename1> [filename2 ...]`

Scripts need `Technical/.env` with `CONFLUENCE_URL`, `CONFLUENCE_USERNAME`, `CONFLUENCE_API_TOKEN`. If `.env` is missing — suggest creating it from a template (e.g. setup-pack `env.example`).

## Project context (Confluence / Jira)

If the project has a dedicated context file (e.g. `Technical/CONFLUENCE_CONTEXT.md` or similar) — use it for current `space_key`, `page_id`, and space structure. If needed, remind the user to update this file for their instance.
