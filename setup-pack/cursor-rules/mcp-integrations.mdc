---
description: MCP и интеграции (Confluence, Jira) — универсальные правила
alwaysApply: true
---

# MCP и интеграции: Confluence, Jira

Универсальные правила для проектов, где используются MCP (mcp-atlassian), Confluence и Jira. Без привязки к конкретным проектам или спейсам.

## Главные принципы

- **Локально-first:** черновики и итерации вести в локальных файлах (Markdown, шаблоны); Confluence обновлять только по явному запросу пользователя («опубликовать», «синхронизировать», «обновить в Confluence»).
- **Confluence — источник истины** для уже опубликованного: перед записью в Confluence учитывать текущее состояние страницы (версия, ручные правки, комментарии).
- **Экономия токенов:** тяжёлые операции (вложения, массовые чтения/записи) по возможности выполнять **скриптами** из папки `Technical/` (REST API), MCP — для поиска, разовой проверки и публикации контента.

## Когда что использовать

| Задача | Предпочтительно |
|--------|------------------|
| Редактировать текст документации | Локальные `.md` в репозитории |
| Узнать актуальное состояние страницы в Confluence | MCP `confluence_get_page` (разово) |
| Найти страницу / разобраться со структурой | MCP поиск (`confluence_search` / CQL) |
| Опубликовать локальные правки в Confluence | MCP: `confluence_get_page` → `confluence_get_comments` → `confluence_update_page` |
| Вложения (загрузка, встраивание картинки, удаление) | Скрипты из `Technical/` (см. ниже) |

## MCP (mcp-atlassian)

- Использовать **mcp-atlassian** по умолчанию для Confluence и Jira (поиск, страницы, задачи, комментарии, метки, доски, спринты и т.д.).
- Контент страниц Confluence создавать в **Markdown** (MCP поддерживает markdown при записи).

## Перед обновлением страницы в Confluence

- Один раз получить текущее содержимое через MCP (`confluence_get_page` по `page_id`), чтобы не перезаписать ручные правки.
- При необходимости запросить комментарии к странице (`confluence_get_comments`) и учесть обсуждения в комментариях.

## Конфликты: сообщать пользователю

- **Confluence:** перед правкой страницы по запросу пользователя при возможности проверить комментарии. Если в комментариях есть альтернативные формулировки или несогласие с текущей версией — кратко сообщить пользователю.
- **Jira:** при изменении полей тикета по запросу — при возможности проверить недавние изменения (changelog) или комментарии. Если недавно меняли те же поля или в комментариях есть противоречащая информация — сообщить о возможном конфликте.

Не блокировать выполнение запроса, но явно перечислить найденные конфликты.

## Вложения Confluence

По возможности управлять вложениями **скриптами** из папки `Technical/`, чтобы не тянуть большой контент через MCP.

- **Список вложений:** MCP `confluence_get_page` (часто возвращает список в `metadata.attachments`) или UI страницы → Attachments.
- **Загрузить файл во вложения:**  
  `Technical/upload_confluence_attachment.py <page_id> <path_to_file>`
- **Загрузить и встроить картинку в страницу:**  
  `Technical/confluence_upload_and_embed_image.py <page_id> <path_to_image> [--anchor "..." --alt "..." --width N]`
- **Удалить вложение** — только по явной просьбе пользователя:  
  `Technical/delete_confluence_attachment.py <page_id> <filename1> [filename2 ...]`

Для работы скриптов нужен `Technical/.env` с `CONFLUENCE_URL`, `CONFLUENCE_USERNAME`, `CONFLUENCE_API_TOKEN`. Если `.env` нет — предложить создать по шаблону (например из setup-pack `env.example`).

## Контекст проекта (Confluence / Jira)

Если в проекте есть отдельный файл с контекстом (например `Technical/CONFLUENCE_CONTEXT.md` или аналог) — использовать его для актуальных `space_key`, `page_id`, структуры спейсов. При необходимости напомнить пользователю обновить этот файл под свой инстанс.
